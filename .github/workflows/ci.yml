name: CI

on:
  push:
    branches:
    - master
    - develop
  pull_request:
    branches:
    - master
    - develop

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Extract libraries
        run: |
          Expand-Archive -Path "Dependencies\lib\Windows\Siv3D.zip" -DestinationPath "Dependencies\lib\Windows\" -force
          Expand-Archive -Path "Dependencies\lib\Windows\ThirdParty.zip" -DestinationPath "Dependencies\lib\Windows\" -force

      - name: Build GUIKit for Windows
        run: msbuild "Windows\OpenSiv3D GUIKit.vcxproj" /p:Configuration=Release /p:Platform=x64

      - name: Build LaunchTest
        run: msbuild "Windows\GUIKit-LaunchTest.vcxproj" /p:Configuration=Release /p:Platform=x64

      - name: Test Launch
        run: .\App\GUIKit-LaunchTest.exe

  macOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Extract libraries
        run: unzip -n Dependencies/lib/macOS.zip -d Dependencies/lib/

      - name: Build GUIKit for macOS
        run: xcodebuild -project macOS/OpenSiv3D-GUIKit.xcodeproj/

      - name: Build Test
        run: xcodebuild -project macOS/OpenSiv3D-GUIKit-Test.xcodeproj/

  linux:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2

      - name: Install package
        run: sudo apt install ninja-build

      - name: Configure
        run: |
          cd Linux/
          mkdir build
          cd build/
          cmake -DCMAKE_BUILD_TYPE=Release -GNinja ..

      - name: Build GUIKit for Linux
        run: |
          cd Linux/build/
          ninja

      - name: Install packeages for OpenSiv3D
        run: |
          sudo apt install -y \
          libasound2-dev \
           libavcodec-dev \
           libavformat-dev \
           libavutil-dev \
           libboost-all-dev \
           libcurl4-openssl-dev \
           libgtk-3-dev \
           libgif-dev \
           libglew-dev \
           libglu1-mesa-dev \
           libharfbuzz-dev \
           libmpg123-dev \
           libopencv-dev \
           libopus-dev \
           libopusfile-dev \
           libsoundtouch-dev \
           libswresample-dev \
           libtiff-dev \
           libturbojpeg0-dev \
           libudev-dev \
           libvorbis-dev \
           libwebp-dev \
           libxft-dev \
           uuid-dev \
           xorg-dev \
           libopenal-dev

      - name: Build LaunchTest
        run: |
          cd Linux/LaunchTest/
          mkdir build
          cd build/
          cmake -DCMAKE_BUILD_TYPE=Release -GNinja ..
          ninja

      - name: Test Launch
        run: ./App/GUIKit-LaunchTest